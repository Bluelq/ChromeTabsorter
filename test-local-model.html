<!DOCTYPE html>
<html>
<head>
    <title>TabSorter AI - Local Model Test</title>
    <style>
        body {
            font-family: -apple-system, system-ui, sans-serif;
            max-width: 800px;
            margin: 40px auto;
            padding: 20px;
            background: #000;
            color: #fff;
        }
        h1 {
            color: #fff;
        }
        .status {
            padding: 20px;
            background: #111;
            border: 1px solid #333;
            border-radius: 8px;
            margin: 20px 0;
            font-family: monospace;
            white-space: pre-wrap;
        }
        button {
            background: #fff;
            color: #000;
            border: none;
            padding: 12px 24px;
            font-size: 16px;
            border-radius: 6px;
            cursor: pointer;
        }
        button:disabled {
            opacity: 0.5;
        }
        .success { color: #4CAF50; }
        .error { color: #f44336; }
        .warning { color: #FFC107; }
    </style>
</head>
<body>
    <h1>TabSorter AI - Local Model Test</h1>
    <p>This page tests if the AI model can load from local files.</p>
    
    <button id="testBtn" onclick="testModel()">Test Local Model</button>
    
    <div class="status" id="status">Ready to test...</div>

    <script src="ext/libs/transformers.bundle.js"></script>
    <script>
        const statusDiv = document.getElementById('status');
        const testBtn = document.getElementById('testBtn');
        
        function log(message, type = '') {
            const timestamp = new Date().toLocaleTimeString();
            const className = type ? ` class="${type}"` : '';
            statusDiv.innerHTML += `<div${className}>[${timestamp}] ${message}</div>`;
        }
        
        async function testModel() {
            testBtn.disabled = true;
            statusDiv.innerHTML = '';
            
            try {
                // Check if Transformers is loaded
                log('Checking Transformers.js bundle...');
                if (window.Transformers) {
                    log('âœ“ Transformers.js loaded successfully', 'success');
                } else {
                    throw new Error('Transformers.js not found in window object');
                }
                
                const { pipeline, env } = window.Transformers;
                
                // Configure for local models
                log('Configuring for local models...');
                env.allowLocalModels = true;
                env.allowRemoteModels = false;
                env.localURL = 'ai/models/';
                
                // Try to load the model
                log('Loading model from ai/models/...');
                const embedder = await pipeline(
                    'feature-extraction',
                    'ai/models/',
                    { 
                        quantized: true,
                        progress_callback: (data) => {
                            if (data && data.progress) {
                                log(`Loading progress: ${Math.round(data.progress)}%`);
                            }
                        }
                    }
                );
                
                log('âœ“ Model loaded successfully!', 'success');
                
                // Test embedding generation
                log('Testing embedding generation...');
                const testText = "Testing semantic similarity with TabSorter AI";
                const output = await embedder(testText, {
                    pooling: 'mean',
                    normalize: true
                });
                
                log(`âœ“ Generated embedding with ${output.data.length} dimensions`, 'success');
                log(`First 5 values: [${Array.from(output.data).slice(0, 5).map(v => v.toFixed(4)).join(', ')}...]`);
                
                // Test similarity
                log('Testing similarity calculation...');
                const output2 = await embedder("AI-powered tab sorting extension", {
                    pooling: 'mean',
                    normalize: true
                });
                
                // Calculate cosine similarity
                let dotProduct = 0;
                for (let i = 0; i < output.data.length; i++) {
                    dotProduct += output.data[i] * output2.data[i];
                }
                
                log(`âœ“ Similarity score: ${dotProduct.toFixed(4)}`, 'success');
                log('', '');
                log('ðŸŽ‰ ALL TESTS PASSED! The model is working locally.', 'success');
                
            } catch (error) {
                log(`âœ— Error: ${error.message}`, 'error');
                console.error('Full error:', error);
                
                // Provide debugging info
                log('', '');
                log('Debugging info:', 'warning');
                log(`- Window.Transformers exists: ${!!window.Transformers}`, 'warning');
                log(`- Current URL: ${window.location.href}`, 'warning');
                log(`- Model files expected at: ai/models/`, 'warning');
            }
            
            testBtn.disabled = false;
        }
        
        // Auto-test on load
        window.addEventListener('load', () => {
            log('Page loaded. Click the button to test the model.');
        });
    </script>
</body>
</html>
